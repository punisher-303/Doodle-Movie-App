name: "Build & Release"

on:
  workflow_dispatch:
    branches: main

jobs:
  build:
    name: Build & Release
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4  # Update from v3.12.0 to v4
        with:
          distribution: 'temurin'  # Changed from 'oracle' (more reliable on CI)
          java-version: '21'

      - name: Clone Repository
        run: git clone https://${{secrets.SECRET_KEY}}@github.com/punisher-303/DoodleMoviesApp.git Doodle

      - name: Install Dependencies
        run: |
          cd Doodle
          npm install

      - name: Get Version from package.json
        id: version
        shell: pwsh
        run: |
          $packageJson = Get-Content -Raw -Path "Doodle\package.json" | ConvertFrom-Json
          echo "VERSION=$($packageJson.version)" >> $env:GITHUB_ENV

      - name: Create keystore file
        run: |
          $b64 = "${{ secrets.KEY_STORE }}"
          $filename = "./Doodle/android/Doodle.jks"
          $bytes = [Convert]::FromBase64String($b64)
          [IO.File]::WriteAllBytes($filename, $bytes)

      - name: Create Keystore properties
        run: |
          echo keyPassword=\${{ secrets.KEY_PASSWORD }} > ./Doodle/android/key.properties
          echo storePassword=\${{ secrets.STORE_PASSWORD }} >> ./Doodle/android/key.properties
          echo keyAlias=\${{ secrets.KEY_ALIAS }} >> ./Doodle/android/key.properties

      - name: Build App file
        run: |
          cd Doodle/android
          ./gradlew assembleRelease -x lintVitalAnalyzeRelease

      - name: Rename APK files
        run: |
          $v = "${{ env.VERSION }}"
          Rename-Item -Path "./Doodle/android/app/build/outputs/apk/release/Doodle-universal-v$v.apk" -NewName "Doodle Movies-Universal-v$v.apk"
          Rename-Item -Path "./Doodle/android/app/build/outputs/apk/release/Doodle-armeabi-v7a-v$v.apk" -NewName "Doodle Movies-32bit-v$v.apk"
          Rename-Item -Path "./Doodle/android/app/build/outputs/apk/release/Doodle-arm64-v8a-v$v.apk" -NewName "Doodle Movies-64bit-v$v.apk"
      
      - name: Verify 16KB Alignment
        run: |
          $v = "${{ env.VERSION }}"
          # Find the user's Android SDK build-tools zipalign executable
          $zipalign = Get-ChildItem -Path "$env:ANDROID_HOME\build-tools" -Filter zipalign.exe -Recurse | Select-Object -Last 1
          Write-Host "Using zipalign: $($zipalign.FullName)"
          
          # List of files to verify
          $apks = @(
            "./Doodle/android/app/build/outputs/apk/release/Doodle Movies-Universal-v$v.apk",
            "./Doodle/android/app/build/outputs/apk/release/Doodle Movies-32bit-v$v.apk",
            "./Doodle/android/app/build/outputs/apk/release/Doodle Movies-64bit-v$v.apk"
          )
          # Verification Loop
          foreach ($apk in $apks) {
            Write-Host "Verifying alignment for: $apk"
            # -c: check, -v: verbose, -P 16: 16KB page align, 4: 4-byte zip align
            & $zipalign.FullName -c -v -P 16 4 $apk
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Verification failed for $apk"
              exit 1
            }
          }
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Release
          path: |
            Doodle/android/app/build/outputs/apk/release/Doodle Movies-Universal-v${{ env.VERSION }}.apk
            Doodle/android/app/build/outputs/apk/release/Doodle Movies-32bit-v${{ env.VERSION }}.apk
            Doodle/android/app/build/outputs/apk/release/Doodle Movies-64bit-v${{ env.VERSION }}.apk

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: |
            Doodle/android/app/build/outputs/apk/release/Doodle Movies-Universal-v${{ env.VERSION }}.apk
            Doodle/android/app/build/outputs/apk/release/Doodle Movies-32bit-v${{ env.VERSION }}.apk
            Doodle/android/app/build/outputs/apk/release/Doodle Movies-64bit-v${{ env.VERSION }}.apk
          tag: v${{ env.VERSION }}
          token: ${{secrets.SECRET_KEY}}
          prerelease: true
          allowUpdates: true
          omitBody: true